// ============================================================================
// ESP32 WATER QUALITY MONITOR
// - Uses your original DO code (table + readDO + calibration)
// - Adds DS18B20 temperature sensor on GPIO4
// - Uses GPIO34 for DO analog input (change if you wire to other ADC1 pin)
// - Sends temperature + DO to Supabase
// ============================================================================

#include <Arduino.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <OneWire.h>
#include <DallasTemperature.h>

// ============================================================================
// 1. USER CONFIG - UPDATE THESE 4 VALUES
// ============================================================================

// WiFi credentials
const char* WIFI_SSID     = "Upcheck_Anna.Uni";
const char* WIFI_PASSWORD = "Upcheck@2026";

// Supabase
const char* SUPABASE_URL  = "https://ydostqcvgxunfeifnblv.supabase.co";  // NO trailing slash
const char* SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkb3N0cWN2Z3h1bmZlaWZuYmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NjY3ODgsImV4cCI6MjA4MjA0Mjc4OH0.tl7nx1rV9R9BvYxNALWPa8o3c5_KSOZwDYC5UA4Fw8c";

// ============================================================================
// 2. PIN CONFIG (ESP32)
// ============================================================================

// DO sensor analog output → choose an ADC1 pin (32, 33, 34, 35, 36, 39)
#define DO_PIN        34    // change if you use a different ADC pin

// DS18B20 data pin
#define TEMP_PIN      4     // you already use 4 for temperature

// ============================================================================
// 3. YOUR ORIGINAL DO CODE (UNCHANGED EXCEPT DO_PIN & READ_TEMP USAGE)
// ============================================================================

#define VREF 5000    // VREF (mv)
// original code uses 10-bit ADC (0‑1023); we will map ESP32 12‑bit to this
#define ADC_RES 1024 // ADC Resolution

// Single-point calibration Mode=0
// Two-point calibration Mode=1
#define TWO_POINT_CALIBRATION 1

// Kept for structure; real temperature comes from DS18B20
#define READ_TEMP (25) // Current water temperature ℃, Or temperature sensor function

// Single point calibration needs to be filled CAL1_V and CAL1_T
#define CAL1_V (751) // mv
#define CAL1_T (34)  // ℃
// Two-point calibration needs to be filled CAL2_V and CAL2_T
// CAL1 High temperature point, CAL2 Low temperature point
#define CAL2_V (463) // mv
#define CAL2_T (14)  // ℃

const uint16_t DO_Table[41] = {
    14460, 14220, 13820, 13440, 13090, 12740, 12420, 12110, 11810, 11530,
    11260, 11010, 10770, 10530, 10300, 10080, 9860, 9660, 9460, 9270,
    9080, 8900, 8730, 8570, 8410, 8250, 8110, 7960, 7820, 7690,
    7560, 7430, 7300, 7180, 7070, 6950, 6840, 6730, 6630, 6530, 6410};

uint8_t  Temperaturet;   // index for DO_Table (0‑40)
uint16_t ADC_Raw;
uint16_t ADC_Voltage;
uint16_t DO_raw;         // raw DO value from your function

int16_t readDO(uint32_t voltage_mv, uint8_t temperature_c)
{
#if TWO_POINT_CALIBRATION == 0
  uint16_t V_saturation = (uint32_t)CAL1_V + (uint32_t)35 * temperature_c - (uint32_t)CAL1_T * 35;
  return (voltage_mv * DO_Table[temperature_c] / V_saturation);
#else
  uint16_t V_saturation = (int16_t)((int8_t)temperature_c - CAL2_T) *
                          ((uint16_t)CAL1_V - CAL2_V) /
                          ((uint8_t)CAL1_T - CAL2_T) + CAL2_V;
  return (voltage_mv * DO_Table[temperature_c] / V_saturation);
#endif
}

// ============================================================================
// 4. TEMPERATURE SENSOR (DS18B20)
// ============================================================================

OneWire oneWire(TEMP_PIN);
DallasTemperature tempSensor(&oneWire);
float waterTempC = 25.0;

// ============================================================================
// 5. WIFI & SUPABASE HELPERS
// ============================================================================

void connectWiFi() {
  Serial.print("Connecting to WiFi: ");
  Serial.println(WIFI_SSID);

  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  int tries = 0;
  while (WiFi.status() != WL_CONNECTED && tries < 20) {
    delay(500);
    Serial.print(".");
    tries++;
  }
  Serial.println();

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("WiFi connected ✅");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("WiFi connection FAILED ❌ (check SSID/password)");
  }
}

void sendToSupabase(float tempC, float doMgL) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected, skipping Supabase POST.");
    return;
  }

  HTTPClient http;
  String url = String(SUPABASE_URL) + "/rest/v1/sensor_readings";

  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Authorization", String("Bearer ") + SUPABASE_KEY);
  http.addHeader("apikey", SUPABASE_KEY);
  http.addHeader("Prefer", "return=minimal");

  String body = "{";
  body += "\"temperature\":" + String(tempC, 2) + ",";
  body += "\"dissolved_oxygen\":" + String(doMgL, 3);
  body += "}";

  Serial.print("POST ");
  Serial.println(url);
  Serial.print("Payload: ");
  Serial.println(body);

  int httpCode = http.POST(body);

  if (httpCode > 0) {
    Serial.print("HTTP status: ");
    Serial.println(httpCode);
    if (httpCode == 200 || httpCode == 201 || httpCode == 204) {
      Serial.println("Supabase insert OK ✅");
    } else {
      Serial.println("Supabase responded with error:");
      Serial.println(http.getString());
    }
  } else {
    Serial.print("HTTP POST failed: ");
    Serial.println(http.errorToString(httpCode));
  }

  http.end();
}

// ============================================================================
// 6. SETUP
// ============================================================================

void setup()
{
  Serial.begin(115200);
  delay(1000);

  Serial.println();
  Serial.println("ESP32 Water Quality Monitor (your DO code + temp + Supabase)");

  // Init temperature sensor
  tempSensor.begin();
  Serial.println("DS18B20 temperature sensor initialized.");

  // DO pin
  pinMode(DO_PIN, INPUT);

  // WiFi
  connectWiFi();
}

// ============================================================================
// 7. MAIN LOOP
// ============================================================================

void loop()
{
  // --- 1) Read temperature from DS18B20 ---
  tempSensor.requestTemperatures();
  float t = tempSensor.getTempCByIndex(0);
  if (t == DEVICE_DISCONNECTED_C || t < -20 || t > 80) {
    Serial.println("Temperature sensor error, using 25.0°C fallback.");
    waterTempC = 25.0;
  } else {
    waterTempC = t;
  }

  // Map actual temperature to DO_Table index 0‑40
  Temperaturet = (uint8_t)constrain(round(waterTempC), 0, 40);

  // --- 2) Read DO analog using your original style ---
  int adcRaw12 = analogRead(DO_PIN);  // ESP32: 0–4095
  // Map 12‑bit (0–4095) to your original 10‑bit (0–1023)
  ADC_Raw = map(adcRaw12, 0, 4095, 0, 1023);
  ADC_Voltage = (uint32_t)VREF * ADC_Raw / ADC_RES;

  DO_raw = readDO(ADC_Voltage, Temperaturet);
  float DO_mgL = DO_raw / 1000.0; // your formula returns µg/L‑like, convert

  // --- 3) Print in the same style plus extra info ---
  Serial.print("Temperaturet(idx):\t" + String(Temperaturet) + "\t");
  Serial.print("WaterTempC:\t" + String(waterTempC, 2) + " °C\t");
  Serial.print("ADC RAW 12-bit:\t" + String(adcRaw12) + "\t");
  Serial.print("ADC RAW 10-bit:\t" + String(ADC_Raw) + "\t");
  Serial.print("ADC Voltage:\t" + String(ADC_Voltage) + " mV\t");
  Serial.println("DO(raw):\t" + String(DO_raw) + " (mg/L: " + String(DO_mgL, 3) + ")");

  // --- 4) Send to Supabase ---
  sendToSupabase(waterTempC, DO_mgL);

  delay(1000);
}

